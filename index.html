<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>電力監控儀表板</title>
    <!-- 引入 Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- 顏色變數 --- */
        :root {
            --sidebar-width: 250px;
            --bg-primary: #f4f7f6;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #d1d5db;
            --nav-bg-hover: #e5e7eb;
            --kwh-color: rgb(239, 68, 68); /* Red */
            --header-height: 60px; /* 頂部標頭高度 */
        }

        .dark-mode {
            --bg-primary: #1f2937;
            --bg-secondary: #2d3748;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #4b5563;
            --nav-bg-hover: #4a5568;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s;
        }

        /* --- 頂部標頭 (Header) 樣式 --- */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 50; 
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            height: var(--header-height);
            display: flex;
            align-items: center; 
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .header-title {
            font-size: 24px;
            font-weight: 800;
            color: #3b82f6; 
            flex-grow: 1; 
        }
        
        /* --- 漢堡圖示動畫樣式 (轉換成 'X') --- */
        .hamburger-line {
            display: block;
            height: 3px;
            width: 100%;
            /* 繼承按鈕的 text-white 顏色，確保圖示清晰可見 */
            background-color: currentColor; 
            border-radius: 9999px;
            /* 所有線條都套用過渡動畫 */
            transition: all 0.3s ease-in-out; 
        }
        
        /* .open class 應用在 #hamburger-icon-container 上 */
        
        /* 1. 頂部線條：向下移動 10.5px 並旋轉 45 度 */
        .open .top-line {
            transform: translateY(10.5px) rotate(45deg); 
        }
        /* 2. 中間線條：隱藏並向左移動 */
        .open .middle-line {
            opacity: 0; 
            transform: translateX(-20px); 
        }
        /* 3. 底部線條：向上移動 10.5px 並旋轉 -45 度 */
        .open .bottom-line {
            transform: translateY(-10.5px) rotate(-45deg); 
        }
        /* --- 結束：漢堡圖示動畫樣式 --- */


        /* --- 側邊欄 (Sidebar) 樣式 --- */

        .sidebar {
            /* 桌面樣式 */
            width: var(--sidebar-width);
            flex-shrink: 0;
            background-color: var(--bg-secondary);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .sidebar-inner {
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: none; 
        }

        /* 導航按鈕樣式 */
        .nav-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }
        
        .nav-button svg {
            stroke: currentColor; 
        }


        .nav-button:hover {
            background-color: var(--nav-bg-hover);
        }

        .nav-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }

        .button-text {
            margin-left: 10px;
        }

        /* --- 主要內容區樣式 (Main Content) --- */

        .main-container {
            display: flex; 
            flex-grow: 1;
        }
        
        .main-content {
            flex-grow: 1;
            padding: 30px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .metric-card {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
        }
        
        /* 指標卡片文字大小 */
        .metric-card .metric-label {
            font-size: 16px; 
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .metric-card .metric-value {
            font-size: 36px; 
            font-weight: 800;
            line-height: 1.2;
            margin: 0;
        }

        .metric-card .metric-unit {
            font-size: 18px; 
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        /* 結束 指標卡片文字大小 */


        .dark-mode .metric-card {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .chart-section {
            background-color: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .chart-canvas-container {
            height: 400px;
            width: 100%;
        }

        .interval-selector {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap; 
        }

        .interval-button {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .interval-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }
        
        .kwh-toggle-button {
            background-color: var(--kwh-color);
            color: #ffffff;
            border-color: var(--kwh-color);
        }

        .kwh-toggle-button.inactive {
            background-color: transparent;
            color: var(--kwh-color);
            border: 1px dashed var(--kwh-color);
        }
        
        .mode-toggle-container {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
/* 新增到 style 區塊 */
#mobile-toggle-btn {
    padding: 8px; /* p-2 */
    width: 40px; /* w-10 */
    height: 40px; /* h-10 */
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%; /* rounded-full */
    color: white; /* text-white */
    background-color: #2563eb; /* bg-blue-600 */
    border: none;
    cursor: pointer;
    transition: background-color 0.2s, box-shadow 0.2s;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); /* shadow-lg */
    position: relative; /* 確保 z-index 能正確工作 */
    z-index: 60; /* 確保它在 header 頂部 */
}
#mobile-toggle-btn:hover {
    background-color: #1d4ed8; /* hover:bg-blue-700 */
}
#hamburger-icon-container {
    width: 24px; /* w-6 */
    height: 24px; /* h-6 */
    display: flex;
    flex-direction: column;
    justify-content: space-between; /* justify-between */
}
        /* --- 響應式調整 (手機模式 < 768px) --- */
        @media (max-width: 767px) {
            
            .main-container {
                flex-direction: column; 
            }

            /* 側邊欄在手機上變成下拉選單，並套用動畫效果 */
            .sidebar {
                position: absolute; 
                top: var(--header-height);
                left: 0;
                width: 100%;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
                z-index: 40; 
                
                max-height: 0;
                opacity: 0;
                overflow: hidden;
                padding-top: 0;
                padding-bottom: 0;

                /* 讓選單展開時有平滑的動畫 */
                transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out;
            }
            
            /* 展開狀態 */
            .sidebar.expanded {
                max-height: 100vh;
                opacity: 1;
                padding-top: 20px;
                padding-bottom: 20px;
            }

            .main-content {
                padding: 10px; 
            }
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            /* 優化：減少圖表區塊內部的填充 */
            .chart-section {
                padding: 15px; 
            }

            .sidebar-inner {
                display: block; 
                margin-bottom: 20px;
            }
        }
        
        /* 僅在桌面模式 (> 767px) 隱藏漢堡包按鈕 */
        @media (min-width: 768px) {
            #mobile-toggle-btn {
                display: none;
            }
        }
    </style>
</head>
<body>

    <!-- 1. 頂部標頭 (在手機上包含收縮按鈕) -->
    <header class="app-header">
        <div class="header-title">電力監控儀表板</div>
        
        <!-- 手機選單切換按鈕 - 藍色圓形按鈕 -->
        <button id="mobile-toggle-btn" 
                class="p-2 w-10 h-10 flex items-center justify-center rounded-full text-white bg-blue-600 hover:bg-blue-700 transition shadow-lg focus:outline-none" 
                onclick="toggleMobileSidebar()">
            
            <!-- Animated Hamburger Icon Structure (使用三條線實現動畫) -->
            <!-- 容器高度 h-6 (24px) -->
            <div class="w-6 h-6 flex flex-col justify-between" id="hamburger-icon-container">
                <span class="hamburger-line top-line"></span>
                <span class="hamburger-line middle-line"></span>
                <span class="hamburger-line bottom-line"></span>
            </div>
            
        </button>
    </header>

    <!-- 2. 主應用程式容器 (包含側邊欄和內容) -->
    <div class="main-container">
        <!-- 側邊欄 (Sidebar) -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-inner">
                 <h2 class="text-xl font-bold text-indigo-400">區域選擇</h2>
            </div>
            
            <div id="area-navigation">
                <!-- 導航按鈕將由 JS 渲染 -->
            </div>
            
            <!-- 深色模式切換按鈕 - 使用 SVG 替代 Emoji，解決佔位符問題 -->
            <div class="mode-toggle-container">
                <button id="dark-mode-toggle" class="nav-button flex justify-center items-center" onclick="toggleDarkMode()">
                    <!-- Moon Icon (初始狀態：深色模式) -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3"/>
                    </svg>
                    <span class="button-text">深色模式</span>
                </button>
            </div>
        </nav>

        <!-- 主要內容 -->
        <div class="main-content">
            <h2 id="dashboard-title" style="font-size: 32px; font-weight: 800; color: var(--text-primary); margin-bottom: 20px;">請選擇一個監控區域</h2>
            
            <div id="dashboard-metrics" class="metrics-grid">
                <!-- 指標卡片將由 JS 渲染 -->
            </div>

            <div id="chart-section" class="chart-section" style="display: none;">
                <div class="interval-selector">
                    <button id="btn-5min_live" class="interval-button active" onclick="switchInterval('5min_live')">即時趨勢 (5分)</button>
                    <button id="btn-3h_live" class="interval-button" onclick="switchInterval('3h_live')">3 小時滾動</button>
                    <button id="btn-custom" class="interval-button" onclick="switchInterval('custom')">自訂區間</button>
                    <!-- 累積電量切換按鈕 -->
                    <button id="btn-toggle-kwh" class="interval-button kwh-toggle-button" onclick="toggleKwhLine()">隱藏累積電量</button>
                </div>
                
                <!-- 自訂區間選擇 UI -->
                <div id="custom-range-selector" style="display: none; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <label for="startDate">開始日期/時間:</label>
                    <input type="datetime-local" id="startDate" value="2025-10-17T00:00" class="p-2 border rounded">
                    <label for="endDate">結束日期/時間:</label>
                    <input type="datetime-local" id="endDate" value="2025-10-17T08:00" class="p-2 border rounded">
                    <button class="interval-button" style="background-color: #10b981; border-color: #10b981; color: white;" onclick="generateCustomChart()">生成圖表</button>
                </div>

                <div class="chart-canvas-container">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 全域變數與常量 ---
        const CHART_5MIN_POINTS = 60;   
        const LIVE_START_INDEX = 30;    
        const CHART_3H_POINTS = 36;     
        const AREA_COUNT = 5;           
        
        let currentChart = null;        
        let selectedAreaId = 'A'; 
        let currentInterval = '5min_live';
        let realTimeInterval = null;    
        let live5MinInterval = null;    
        let live3HourInterval = null;   
        let live5MinCounter = LIVE_START_INDEX; 
        let isDarkMode = false;
        let showKwhLine = true;         
        
        const areaData = [];
        
        // --- 初始化邏輯：3小時歷史數據預生成 ---

        function initAreaHistory(areaId, basePower, basePF) {
            const now = new Date();
            const initialData = { labels: [], powerData: [], pfData: [], kwhData: [] }; 
            const intervalMs = 5 * 60 * 1000; 
            let cumulativeEnergy = 0;
            const points = CHART_3H_POINTS; 

            for(let i = 0; i < points; i++) {
                 const time = new Date(now.getTime() - (points - 1 - i) * intervalMs);
                 
                 initialData.labels.push(time.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', hour12: false }));
                 
                 const areaFactor = areaId.charCodeAt(0) - 'A'.charCodeAt(0) + 1;
                 const dailyCycleFactor = 1 + Math.sin((time.getHours() / 24) * 2 * Math.PI) * (0.1 * areaFactor);

                 let simulatedPower = (basePower * dailyCycleFactor) + (Math.random() - 0.5) * 1.5;
                 let simulatedPF = basePF + (Math.random() - 0.5) * 0.05;
                 
                 simulatedPF = Math.min(1.0, Math.max(0.7, simulatedPF));
                 
                 initialData.powerData.push(simulatedPower); 
                 initialData.pfData.push(simulatedPF);
                 
                 cumulativeEnergy += simulatedPower * (5 / 60);
                 initialData.kwhData.push(cumulativeEnergy);
            }
            return initialData;
        }

        function initializeAppData() {
            const initialAreaNames = ['區域 A - 機房核心', '區域 B - 辦公室樓層', '區域 C - 研發實驗室', '區域 D - 休息與餐飲區', '區域 E - 戶外照明'];
            const initialBasePowers = [12.55, 4.12, 8.90, 1.50, 0.80];
            const initialBasePFs = [0.98, 0.85, 0.99, 0.92, 0.95];
            
            for(let i = 0; i < AREA_COUNT; i++) {
                const id = String.fromCharCode('A'.charCodeAt(0) + i);
                const basePower = initialBasePowers[i];
                const basePF = initialBasePFs[i];
                const threeHourHistory = initAreaHistory(id, basePower, basePF);

                areaData.push({ 
                    id: id, 
                    name: initialAreaNames[i], 
                    latest: { 
                        realTimePower: basePower, 
                        current: 0, 
                        voltage: 220.0, 
                        powerFactor: basePF, 
                        dailyEnergy: threeHourHistory.kwhData[threeHourHistory.kwhData.length - 1], 
                    }, 
                    liveHistory: null, 
                    eightHourHistory: threeHourHistory 
                });
                
                const latest = areaData[i].latest;
                const nominalCurrentFactor = 2.85; 
                latest.current = latest.realTimePower * nominalCurrentFactor / latest.powerFactor / 220.0 * latest.voltage;
                latest.current = parseFloat(latest.current.toFixed(2));
            }
        }

        // --- 核心邏輯：指標更新 (1 秒) ---
        
        function renderMetricCard(label, value, unit, colorClass) {
            return `<div class="metric-card"><p class="metric-label">${label}</p><p class="metric-value" style="color: ${colorClass};">${value.toFixed(2)}</p><p class="metric-unit">${unit}</p></div>`;
        }

        function renderMetrics(data) {
            const container = document.getElementById('dashboard-metrics');
            const latest = data.latest;
            const pfColor = latest.powerFactor < 0.9 ? '#ef4444' : '#10b981';

            container.innerHTML = `
                ${renderMetricCard("即時用電", latest.realTimePower, "kW", "#3b82f6")}
                ${renderMetricCard("當日累積", latest.dailyEnergy, "kWh", "#f59e0b")}
                ${renderMetricCard("功率因素", latest.powerFactor, "PF", pfColor)}
                ${renderMetricCard("電流", latest.current, "A", "#8b5cf6")}
                ${renderMetricCard("電壓", latest.voltage, "V", "#4b5563")}
            `;
        }

        function startRealTimeUpdates() {
            if (realTimeInterval) clearInterval(realTimeInterval);

            realTimeInterval = setInterval(() => {
                const selectedData = areaData.find(d => d.id === selectedAreaId);
                
                if (selectedData) {
                    let latest = selectedData.latest;
                    let currentPower = latest.realTimePower;

                    const powerFluctuation = (Math.random() - 0.5) * 0.3; 
                    let newPower = Math.min(Math.max(currentPower + powerFluctuation, 0.1), 15); 
                    
                    latest.dailyEnergy += newPower * (1 / 3600); 

                    const voltageFluctuation = (Math.random() - 0.5) * 0.1;
                    latest.voltage = 220.0 + voltageFluctuation;

                    const pfFluctuation = (Math.random() - 0.5) * 0.005; 
                    let newPF = latest.powerFactor + pfFluctuation;
                    latest.powerFactor = Math.min(1.0, Math.max(0.7, newPF)); 

                    const nominalCurrentFactor = 2.85; 
                    latest.current = newPower * nominalCurrentFactor / latest.powerFactor / 220.0 * latest.voltage;
                    
                    latest.realTimePower = parseFloat(newPower.toFixed(2));
                    latest.dailyEnergy = parseFloat(latest.dailyEnergy.toFixed(3));
                    latest.current = parseFloat(latest.current.toFixed(2));
                    latest.voltage = parseFloat(latest.voltage.toFixed(2));

                    renderMetrics(selectedData);
                }
            }, 1000); 
        }

        // --- 圖表相關函數 ---

        function getCurrentTimeLabel(includeSeconds = true) {
            const options = { hour: '2-digit', minute: '2-digit', hour12: false };
            if (includeSeconds) {
                options.second = '2-digit';
            }
            return new Date().toLocaleTimeString('zh-Hant', options);
        }

        function stopAllChartIntervals() {
            if (live5MinInterval) clearInterval(live5MinInterval);
            if (live3HourInterval) clearInterval(live3HourInterval);
            live5MinInterval = null;
            live3HourInterval = null;
        }
        
        function getChartColors() {
            const isDark = document.body.classList.contains('dark-mode');
            return {
                gridColor: isDark ? 'rgba(255, 255, 255, 0.15)' : 'rgba(0, 0, 0, 0.1)',
                labelColor: isDark ? '#f9fafb' : '#1f2937',
                legendColor: isDark ? '#f9fafb' : '#1f2937'
            };
        }
        
        function init5MinHistory(selectedData) {
            const initialHistory = { labels: [], powerData: [] };
            const now = new Date();
            const intervalMs = 5000; 
            const basePower = selectedData.latest.realTimePower;

            for (let i = 0; i < CHART_5MIN_POINTS; i++) {
                const time = new Date(now.getTime() + (i - LIVE_START_INDEX) * intervalMs);
                const label = time.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                
                initialHistory.labels.push(label);

                if (i < LIVE_START_INDEX) {
                    const noise = (Math.sin(i * 0.5) * 0.5) + (Math.random() - 0.5) * 0.5;
                    initialHistory.powerData.push(basePower + noise); 
                } else {
                    initialHistory.powerData.push(null); 
                }
            }
            
            selectedData.liveHistory = initialHistory;
            live5MinCounter = LIVE_START_INDEX;
        }

        function startLive5MinUpdates(selectedData) {
            stopAllChartIntervals();
            
            if (!selectedData.liveHistory) {
                init5MinHistory(selectedData);
            }
            
            if (!selectedData.liveHistory.powerData.includes(null)) {
                live5MinCounter = CHART_5MIN_POINTS;
            } else if (live5MinCounter === 0) {
                 live5MinCounter = LIVE_START_INDEX;
            }


            live5MinInterval = setInterval(() => {
                const newPower = selectedData.latest.realTimePower;
                const newLabel = getCurrentTimeLabel(); 

                if (live5MinCounter < CHART_5MIN_POINTS) {
                    selectedData.liveHistory.powerData[live5MinCounter] = newPower;
                    selectedData.liveHistory.labels[live5MinCounter] = newLabel;
                    live5MinCounter++;

                } else {
                    selectedData.liveHistory.labels.shift();
                    selectedData.liveHistory.powerData.shift();
                    
                    selectedData.liveHistory.labels.push(newLabel);
                    selectedData.liveHistory.powerData.push(newPower);
                }
                
                if (currentChart && currentInterval === '5min_live') {
                    currentChart.data.labels = selectedData.liveHistory.labels;
                    currentChart.data.datasets[0].data = selectedData.liveHistory.powerData;
                    
                    const basePower = selectedData.latest.realTimePower;
                    currentChart.options.scales.y1.suggestedMin = Math.max(0, basePower - 1.5);
                    currentChart.options.scales.y1.suggestedMax = basePower + 1.5;
                    
                    currentChart.update('none'); 
                }
            }, 5000); 
        }

        function startLive3HourUpdates(selectedData) {
            stopAllChartIntervals();
            const threeHourHistory = selectedData.eightHourHistory; 

            live3HourInterval = setInterval(() => {
                const latest = selectedData.latest;
                const newPower = latest.realTimePower; 
                const newPF = latest.powerFactor;
                const newEnergy = latest.dailyEnergy; 
                const newLabel = getCurrentTimeLabel(false); 

                threeHourHistory.labels.shift();
                threeHourHistory.powerData.shift();
                threeHourHistory.pfData.shift();
                threeHourHistory.kwhData.shift();
                
                threeHourHistory.labels.push(newLabel);
                threeHourHistory.powerData.push(newPower); 
                threeHourHistory.pfData.push(newPF);
                threeHourHistory.kwhData.push(newEnergy);

                if (currentChart && currentInterval === '3h_live') {
                    currentChart.data.labels = threeHourHistory.labels;
                    currentChart.data.datasets[0].data = threeHourHistory.powerData;
                    currentChart.data.datasets[1].data = threeHourHistory.pfData;
                    
                    if (showKwhLine) {
                         currentChart.data.datasets[2].data = threeHourHistory.kwhData;
                    }
                   
                    currentChart.update('none'); 
                }
            }, 10000); 
        }

        function generateCustomData(data, startDate, endDate) {
            const diffMs = endDate.getTime() - startDate.getTime();
            const diffHours = diffMs / (1000 * 60 * 60);
            const dataPoints = Math.min(200, Math.ceil(diffHours * 10)); 

            const customLabels = [];
            const customPowerData = []; 
            const customPfData = [];
            const customKwhData = []; 
            const stepMs = diffMs / dataPoints;
            
            let currentMs = startDate.getTime();
            const basePower = data.latest.realTimePower;
            const basePF = data.latest.powerFactor;
            let cumulativeEnergy = 0;

            for (let i = 0; i < dataPoints; i++) {
                const time = new Date(currentMs);
                customLabels.push(time.toLocaleDateString('zh-Hant', { month: '2-digit', day: '2-digit' }) + ' ' + time.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', hour12: false }));
                
                const activityFactor = 1 + Math.sin(time.getHours() / 12 * Math.PI) * 0.5; 
                let simulatedPower = (basePower * activityFactor) + (Math.random() * 2);
                customPowerData.push(simulatedPower); 
                
                let simulatedPF = basePF + (Math.random() - 0.5) * 0.03;
                customPfData.push(Math.min(1.0, Math.max(0.7, simulatedPF))); 

                cumulativeEnergy += simulatedPower * (stepMs / (1000 * 60 * 60));
                customKwhData.push(cumulativeEnergy);

                currentMs += stepMs;
            }

            return { labels: customLabels, powerData: customPowerData, pfData: customPfData, kwhData: customKwhData };
        }

        function renderChart(data, interval, isCustom = false) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            
            if (currentChart) currentChart.destroy();
            
            const colors = getChartColors();
            
            let datasets = [];
            let chartLabels = [];
            let chartTitle = '';
            let chartData = isCustom ? data.history : 
                            interval === '5min_live' ? data.liveHistory : 
                            data.eightHourHistory;

            if (!chartData || chartData.labels.length === 0) {
                if(interval === '5min_live') init5MinHistory(data);
                chartData = data.liveHistory; 
            }


            if (interval === '5min_live') {
                chartLabels = chartData.labels;
                datasets.push({
                    label: '即時用電 (kW)',
                    data: chartData.powerData,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    yAxisID: 'y1',
                    pointRadius: 3, 
                    pointHoverRadius: 5,
                    tension: 0.1,
                    spanGaps: true,
                });
                chartTitle = `${data.name} - 即時用電趨勢 (5分鐘)`;

            } else { 
                chartLabels = chartData.labels;
                
                datasets.push({ 
                    label: '即時用電 (kW)', 
                    data: chartData.powerData, 
                    borderColor: 'rgb(59, 130, 246)', 
                    backgroundColor: 'rgba(59, 130, 246, 0.2)', 
                    yAxisID: 'y1', 
                    tension: 0.4,
                    pointRadius: 2, 
                    fill: 'origin',
                });
                
                datasets.push({ 
                    label: '功率因素 (PF)', 
                    data: chartData.pfData, 
                    borderColor: 'rgb(16, 185, 129)', 
                    backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                    yAxisID: 'y2', 
                    tension: 0.4,
                    pointRadius: 2,
                });

                if (showKwhLine) {
                    datasets.push({ 
                        label: '累積電量 (kWh)', 
                        data: chartData.kwhData, 
                        borderColor: 'rgb(239, 68, 68)', 
                        backgroundColor: 'rgba(239, 68, 68, 0.1)', 
                        yAxisID: 'y3', 
                        tension: 0.4,
                        pointRadius: 2,
                        borderWidth: 3,
                    });
                }
                
                chartTitle = isCustom ? `${data.name} - 自訂區間電力趨勢` : `${data.name} - 3 小時即時電力滾動`;
            }

            currentChart = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: datasets },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false, },
                    plugins: { 
                        title: { display: true, text: chartTitle, font: { size: 16 }, color: colors.labelColor },
                        legend: { position: 'top', labels: { color: colors.legendColor } }
                    },
                    scales: { 
                        x: {
                            ticks: { 
                                maxTicksLimit: interval === '5min_live' ? 10 : 15,
                                autoSkipPadding: 20,
                                color: colors.labelColor
                            },
                            grid: { color: colors.gridColor }
                        },
                        y1: { 
                            type: 'linear', display: true, position: 'left', 
                            title: { display: true, text: '電力 (kW)', color: colors.labelColor }, 
                            ticks: { color: colors.labelColor },
                            grid: { color: colors.gridColor },
                            suggestedMin: (interval === '5min_live') ? Math.max(0, data.latest.realTimePower - 2) : undefined,
                            suggestedMax: (interval === '5min_live') ? data.latest.realTimePower + 2 : undefined,
                            min: 0,
                        },
                        y2: { 
                            type: 'linear', 
                            display: interval !== '5min_live',
                            position: 'right', 
                            min: 0.7, 
                            max: 1.0, 
                            title: { display: interval !== '5min_live', text: '功率因素 (PF)', color: colors.labelColor }, 
                            ticks: { color: colors.labelColor },
                            grid: { drawOnChartArea: false, color: colors.gridColor }, 
                        },
                         y3: { 
                            type: 'linear', 
                            display: showKwhLine && interval !== '5min_live',
                            position: 'right', 
                            min: 0,
                            title: { display: showKwhLine && interval !== '5min_live', text: '累積電量 (kWh)', color: 'rgb(239, 68, 68)' }, 
                            ticks: { color: 'rgb(239, 68, 68)' },
                            grid: { drawOnChartArea: false, color: colors.gridColor }, 
                        },
                    },
                },
            });
            document.getElementById('chart-section').style.display = 'block';
        }

        // --- 響應式：手機模式下收縮/展開選單 ---
        function isMobileView() {
            // 與 CSS 中的 @media (max-width: 767px) 匹配
            return window.matchMedia("(max-width: 767px)").matches;
        }

        window.toggleMobileSidebar = function(forceClose = false) {
            const sidebar = document.getElementById('sidebar');
            const iconContainer = document.getElementById('hamburger-icon-container'); // 取得動畫圖示容器
            
            if (!isMobileView()) return; 

            const isExpanded = sidebar.classList.contains('expanded');
            
            if (forceClose || isExpanded) {
                // 收縮
                sidebar.classList.remove('expanded');
                if (iconContainer) iconContainer.classList.remove('open'); // 關閉圖示動畫 (變回漢堡)
            } else {
                // 展開
                sidebar.classList.add('expanded');
                if (iconContainer) iconContainer.classList.add('open'); // 開啟圖示動畫 (變為 X)
            }
        }
        
        // 處理視窗大小變化，確保選單狀態正確
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            const iconContainer = document.getElementById('hamburger-icon-container'); // 取得動畫圖示容器
            
            if (!isMobileView()) {
                // 桌面模式：確保選單是完全展開的（移除手機收縮類別）
                sidebar.classList.remove('expanded'); 
                if (iconContainer) iconContainer.classList.remove('open'); // 重設圖示
            } else {
                 // 手機模式：預設收起來
                 sidebar.classList.remove('expanded');
                 if (iconContainer) iconContainer.classList.remove('open'); // 重設圖示
            }
        });


        // --- 其他事件處理函數 ---
        
        window.toggleKwhLine = function() {
            if (currentInterval === '5min_live') return;

            showKwhLine = !showKwhLine;
            const toggleBtn = document.getElementById('btn-toggle-kwh');

            if (showKwhLine) {
                toggleBtn.textContent = '隱藏累積電量';
                toggleBtn.classList.remove('inactive');
            } else {
                toggleBtn.textContent = '顯示累積電量';
                toggleBtn.classList.add('inactive');
            }
            
            const selectedData = areaData.find(d => d.id === selectedAreaId);
            
            if (currentInterval === 'custom') {
                 const startDate = new Date(document.getElementById('startDate').value);
                 const endDate = new Date(document.getElementById('endDate').value);
                 const customHistory = generateCustomData(selectedData, startDate, endDate);
                 renderChart({...selectedData, history: customHistory}, 'custom', true);
            } else {
                renderChart(selectedData, currentInterval);
            }
        }

        window.switchArea = function(id) {
            selectedAreaId = id;
            const selectedData = areaData.find(d => d.id === id);

            if (selectedData) {
                const isDark = document.body.classList.contains('dark-mode');
                document.getElementById('dashboard-title').style.color = isDark ? 'var(--text-primary)' : '#1f2937';
                document.getElementById('dashboard-title').textContent = `${selectedData.name} - 監控儀表板`;
                
                renderMetrics(selectedData);
                startRealTimeUpdates();
                
                switchInterval('5min_live'); 
                
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`btn-${id}`).classList.add('active');

                // 新增：在手機模式下，選完區域後自動收起選單
                window.toggleMobileSidebar(true);
            }
        };

        window.switchInterval = function(interval) {
            currentInterval = interval;
            const selectedData = areaData.find(d => d.id === selectedAreaId);
            const kwhToggleBtn = document.getElementById('btn-toggle-kwh');

            document.querySelectorAll('.interval-button').forEach(btn => {
                 if (btn.id !== 'btn-toggle-kwh') {
                    btn.classList.remove('active');
                 }
            });
            if (document.getElementById(`btn-${interval}`)) {
                document.getElementById(`btn-${interval}`).classList.add('active');
            }

            if (interval === '5min_live') {
                kwhToggleBtn.style.display = 'none';
            } else {
                kwhToggleBtn.style.display = 'inline-block';
                if (showKwhLine) {
                    kwhToggleBtn.textContent = '隱藏累積電量';
                    kwhToggleBtn.classList.remove('inactive');
                } else {
                    kwhToggleBtn.textContent = '顯示累積電量';
                    kwhToggleBtn.classList.add('inactive');
                }
            }

            const customSelector = document.getElementById('custom-range-selector');
            customSelector.style.display = interval === 'custom' ? 'flex' : 'none';

            stopAllChartIntervals();

            if (interval === '5min_live') {
                selectedData.liveHistory = null; 
                renderChart(selectedData, '5min_live');
                startLive5MinUpdates(selectedData);
            } else if (interval === '3h_live') { 
                renderChart(selectedData, '3h_live');
                startLive3HourUpdates(selectedData); 
            } else {
                if (currentChart) currentChart.destroy();
            }
        }

        window.generateCustomChart = function() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            
            if (!startDateInput || !endDateInput) {
                console.error("請選擇有效的開始和結束日期時間！");
                return;
            }

            const startDate = new Date(startDateInput);
            const endDate = new Date(endDateInput);
            
            if (startDate >= endDate) {
                console.error("開始時間必須早於結束時間！");
                return;
            }

            stopAllChartIntervals();

            const selectedData = areaData.find(d => d.id === selectedAreaId);
            const customHistory = generateCustomData(selectedData, startDate, endDate);
            
            const customDataWrapper = {
                ...selectedData,
                history: customHistory
            };
            
            renderChart(customDataWrapper, 'custom', true);
        }
        
        window.toggleDarkMode = function() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const modeBtn = document.getElementById('dark-mode-toggle');
            
            // 由於 isDarkMode 已經被切換，我們檢查它的新狀態
            if (isDarkMode) {
                // 現在是深色模式 -> 按鈕顯示切換到淺色模式 (Sun Icon)
                modeBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                    </svg>
                    <span class="button-text">淺色模式</span>
                `;
            } else {
                // 現在是淺色模式 -> 按鈕顯示切換到深色模式 (Moon Icon)
                modeBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3"/>
                    </svg>
                    <span class="button-text">深色模式</span>
                `;
            }
            
            if (currentChart) {
                const selectedData = areaData.find(d => d.id === selectedAreaId);
                
                if (currentInterval === 'custom') {
                    const startDate = new Date(document.getElementById('startDate').value);
                    const endDate = new Date(document.getElementById('endDate').value);
                    const customHistory = generateCustomData(selectedData, startDate, endDate);
                    renderChart({...selectedData, history: customHistory}, 'custom', true);
                } else {
                    renderChart(selectedData, currentInterval);
                }
            }
            const titleElement = document.getElementById('dashboard-title');
            titleElement.style.color = isDarkMode ? 'var(--text-primary)' : '#1f2937';
        }
        

        // --- 啟動函數 ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppData();
            
            // 渲染導航按鈕
            const navContainer = document.getElementById('area-navigation');
            areaData.forEach(area => {
                const button = document.createElement('button');
                button.className = 'nav-button';
                button.id = `btn-${area.id}`;
                button.innerHTML = `<span class="button-id">${area.id}</span><span class="button-text">${area.name}</span>`;
                button.onclick = () => window.switchArea(area.id);
                navContainer.appendChild(button);
            });

            // 預設選擇第一個區域
            window.switchArea('A');
        });

    </script>
</body>
</html>
