<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»åŠ›ç›£æ§å„€è¡¨æ¿</title>
    <!-- å¼•å…¥ Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        :root {
            /* Light Mode Variables */
            --bg-color: #f4f7f6;
            --main-bg-color: #ffffff;
            --text-color: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --chart-grid-color: rgba(0, 0, 0, 0.1);
            --sidebar-active-bg: #3b82f6;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #e5e7eb;
            --sidebar-text: #4b5563;
        }

        .dark-mode {
            /* Dark Mode Variables */
            --bg-color: #1f2937;
            --main-bg-color: #374151;
            --text-color: #f3f4f6;
            --text-secondary: #9ca3af;
            --border-color: #4b5563;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --chart-grid-color: rgba(255, 255, 255, 0.1);
            --sidebar-active-bg: #3b82f6;
            --sidebar-active-text: #ffffff;
            --sidebar-hover-bg: #4b5563;
            --sidebar-text: #d1d5db;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .sidebar {
            width: 250px;
            background-color: var(--main-bg-color);
            box-shadow: 2px 0 5px var(--shadow-color);
            padding: 20px;
            flex-shrink: 0;
            transition: background-color 0.3s, box-shadow 0.3s;
        }
        
        .main-content {
            flex-grow: 1;
            padding: 30px;
        }

        .title {
            font-size: 24px;
            font-weight: 800;
            color: #1e40af; /* è—è‰²æ¨™é¡Œä¸éš¨æ·±è‰²æ¨¡å¼æ”¹è®Šï¼Œä¿æŒé†’ç›® */
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3b82f6;
        }

        /* å°èˆªæŒ‰éˆ•æ¨£å¼ */
        .nav-button {
            display: block;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: none;
            background-color: transparent;
            color: var(--sidebar-text);
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            font-weight: 500;
        }

        .nav-button:hover {
            background-color: var(--sidebar-hover-bg);
        }

        .nav-button.active {
            background-color: var(--sidebar-active-bg);
            color: var(--sidebar-active-text);
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3), 0 2px 4px -2px rgba(59, 130, 246, 0.3);
        }

        /* æŒ‡æ¨™å¡ç‰‡æ¨£å¼ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .metric-card {
            background-color: var(--main-bg-color);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-color);
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
        }

        .metric-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px var(--shadow-color);
        }

        .metric-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 5px;
            transition: color 0.3s;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-top: 0;
            line-height: 1.1;
        }

        .metric-unit {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .chart-section {
            background-color: var(--main-bg-color);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-color);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .chart-canvas-container {
            height: 400px;
            width: 100%;
        }

        /* å€é–“é¸æ“‡æŒ‰éˆ•çµ„ */
        .interval-selector {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap; 
        }

        .interval-button {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-color);
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .interval-button:hover {
            background-color: var(--sidebar-hover-bg);
            color: var(--sidebar-text);
        }
        
        .dark-mode .interval-button:hover {
            background-color: var(--sidebar-hover-bg);
            color: var(--sidebar-active-text);
        }

        .interval-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }

        /* è‡ªè¨‚å€é–“æ¨£å¼ */
        #custom-range-selector {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            transition: background-color 0.3s;
        }

        #custom-range-selector label {
            font-weight: 500;
            color: var(--text-color);
            transition: color 0.3s;
        }

        #custom-range-selector input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
            background-color: var(--main-bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, border-color 0.3s, color 0.3s;
        }

        /* éŸ¿æ‡‰å¼èª¿æ•´ */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
                box-shadow: 0 2px 5px var(--shadow-color);
            }
            .main-content {
                padding: 20px;
            }
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .title {
                font-size: 20px;
            }
            #custom-range-selector {
                flex-direction: column;
                align-items: stretch;
            }
            #custom-range-selector label {
                margin-top: 5px;
            }
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h1 class="title">é›»åŠ›ç›£æ§</h1>
        <div id="area-navigation">
            <!-- å°èˆªæŒ‰éˆ•å°‡ç”± JS æ¸²æŸ“ -->
        </div>
        
        <!-- æ·±è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
            <button class="nav-button" onclick="toggleDarkMode()">
                <span id="dark-mode-icon" style="margin-right: 8px;">ğŸŒ™</span> åˆ‡æ›æ·±è‰²æ¨¡å¼
            </button>
        </div>
    </div>

    <div class="main-content">
        <h2 id="dashboard-title" style="font-size: 32px; font-weight: 800; color: var(--text-color); margin-bottom: 20px; transition: color 0.3s;">è«‹é¸æ“‡ä¸€å€‹ç›£æ§å€åŸŸ</h2>
        
        <div id="dashboard-metrics" class="metrics-grid">
            <!-- æŒ‡æ¨™å¡ç‰‡å°‡ç”± JS æ¸²æŸ“ -->
        </div>

        <div id="chart-section" class="chart-section" style="display: none;">
            <div class="interval-selector">
                <button id="btn-5min_live" class="interval-button active" onclick="switchInterval('5min_live')">å³æ™‚è¶¨å‹¢ (5åˆ†)</button>
                <button id="btn-8h_live" class="interval-button" onclick="switchInterval('8h_live')">8 å°æ™‚æ»¾å‹•</button>
                <button id="btn-custom" class="interval-button" onclick="switchInterval('custom')">è‡ªè¨‚å€é–“</button>
            </div>
            
            <!-- è‡ªè¨‚å€é–“é¸æ“‡ UI -->
            <div id="custom-range-selector" style="display: none;">
                <label for="startDate">é–‹å§‹æ—¥æœŸ/æ™‚é–“:</label>
                <input type="datetime-local" id="startDate" value="2025-10-17T00:00">
                <label for="endDate">çµæŸæ—¥æœŸ/æ™‚é–“:</label>
                <input type="datetime-local" id="endDate" value="2025-10-17T08:00">
                <button class="interval-button" style="background-color: #10b981; border-color: #10b981; color: white;" onclick="generateCustomChart()">ç”Ÿæˆåœ–è¡¨</button>
            </div>

            <div class="chart-canvas-container">
                <canvas id="historyChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡å¸¸é‡ ---
        const CHART_5MIN_POINTS = 60;   
        const LIVE_START_INDEX = 30;    
        const CHART_8H_POINTS = 96;     
        
        let currentChart = null;        
        let selectedAreaId = 'A'; 
        let currentInterval = '5min_live';
        let realTimeInterval = null;    
        let live5MinInterval = null;    
        let live8HourInterval = null;   
        let live5MinCounter = LIVE_START_INDEX; 

        // æ¨¡æ“¬æ•¸æ“šçµæ§‹
        const areaData = [
            { id: 'A', name: 'å€åŸŸ A - æ©Ÿæˆ¿æ ¸å¿ƒ', latest: { realTimePower: 12.55, current: 35.8, voltage: 220.1, powerFactor: 0.98, dailyEnergy: 158.7, }, liveHistory: null, eightHourHistory: null },
            { id: 'B', name: 'å€åŸŸ B - è¾¦å…¬å®¤æ¨“å±¤', latest: { realTimePower: 4.12, current: 12.5, voltage: 220.5, powerFactor: 0.85, dailyEnergy: 95.3, }, liveHistory: null, eightHourHistory: null },
            { id: 'C', name: 'å€åŸŸ C - ç ”ç™¼å¯¦é©—å®¤', latest: { realTimePower: 8.90, current: 28.1, voltage: 220.0, powerFactor: 0.99, dailyEnergy: 110.5 }, liveHistory: null, eightHourHistory: null },
            { id: 'D', name: 'å€åŸŸ D - ä¼‘æ¯èˆ‡é¤é£²å€', latest: { realTimePower: 1.50, current: 5.2, voltage: 220.3, powerFactor: 0.92, dailyEnergy: 35.0 }, liveHistory: null, eightHourHistory: null },
            { id: 'E', name: 'å€åŸŸ E - æˆ¶å¤–ç…§æ˜', latest: { realTimePower: 0.80, current: 3.0, voltage: 220.2, powerFactor: 0.95, dailyEnergy: 15.2 }, liveHistory: null, eightHourHistory: null },
        ];
        
        // --- å¯¦ç”¨å‡½æ•¸ ---
        
        function getCurrentTimeLabel(includeSeconds = true) {
            const options = { hour: '2-digit', minute: '2-digit', hour12: false };
            if (includeSeconds) {
                options.second = '2-digit';
            }
            return new Date().toLocaleTimeString('zh-Hant', options);
        }

        function stopAllChartIntervals() {
            if (live5MinInterval) clearInterval(live5MinInterval);
            if (live8HourInterval) clearInterval(live8HourInterval);
            live5MinInterval = null;
            live8HourInterval = null;
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæŒ‡æ¨™æ›´æ–° (1 ç§’) ---

        function renderMetricCard(label, value, unit, colorClass) {
            return `<div class="metric-card"><p class="metric-label">${label}</p><p class="metric-value" style="color: ${colorClass};">${value.toFixed(2)}</p><p class="metric-unit">${unit}</p></div>`;
        }

        function renderMetrics(data) {
            const container = document.getElementById('dashboard-metrics');
            const latest = data.latest;
            const pfColor = latest.powerFactor < 0.9 ? '#ef4444' : '#10b981';

            container.innerHTML = `
                ${renderMetricCard("å³æ™‚ç”¨é›»", latest.realTimePower, "kW", "#3b82f6")}
                ${renderMetricCard("ç•¶æ—¥ç´¯ç©", latest.dailyEnergy, "kWh", "#f59e0b")}
                ${renderMetricCard("åŠŸç‡å› ç´ ", latest.powerFactor, "PF", pfColor)}
                ${renderMetricCard("é›»æµ", latest.current, "A", "#8b5cf6")}
                ${renderMetricCard("é›»å£“", latest.voltage, "V", "#4b5563")}
            `;
        }

        function startRealTimeUpdates() {
            if (realTimeInterval) clearInterval(realTimeInterval);

            realTimeInterval = setInterval(() => {
                const selectedData = areaData.find(d => d.id === selectedAreaId);
                
                if (selectedData) {
                    let latest = selectedData.latest;
                    let currentPower = latest.realTimePower;

                    // 1. å³æ™‚ç”¨é›» (Power) - æ³¢å‹•
                    const powerFluctuation = (Math.random() - 0.5) * 0.3; 
                    let newPower = Math.min(Math.max(currentPower + powerFluctuation, 0.1), currentPower + 0.5); 
                    
                    // 2. ç•¶æ—¥ç´¯ç© (Daily Energy) - ç´¯ç©
                    latest.dailyEnergy += newPower * (1 / 3600); 

                    // 3. é›»å£“ (Voltage) - æ³¢å‹•
                    const voltageFluctuation = (Math.random() - 0.5) * 0.1;
                    latest.voltage = 220.0 + voltageFluctuation;

                    // 4. åŠŸç‡å› ç´  (Power Factor) - æ³¢å‹•
                    const pfFluctuation = (Math.random() - 0.5) * 0.005; 
                    latest.powerFactor = Math.min(1.0, Math.max(0.7, latest.powerFactor + pfFluctuation)); 

                    // 5. é›»æµ (Current) - è¯å‹•
                    const nominalCurrentFactor = 2.85; 
                    latest.current = newPower * nominalCurrentFactor / latest.powerFactor / 220.0 * latest.voltage;
                    
                    latest.realTimePower = newPower;
                    latest.dailyEnergy = parseFloat(latest.dailyEnergy.toFixed(3));
                    latest.current = parseFloat(latest.current.toFixed(2));
                    latest.voltage = parseFloat(latest.voltage.toFixed(2));

                    renderMetrics(selectedData);
                }
            }, 1000); 
        }

        // --- 5 åˆ†é˜å³æ™‚è¶¨å‹¢åˆå§‹åŒ– ---
        function init5MinHistory(selectedData) {
            const powerBaseline = selectedData.latest.realTimePower;
            const initialHistory = { labels: [], powerData: [] };
            const now = new Date();
            const intervalMs = 5000; // 5 ç§’é–“éš”
            let simulatedPower = powerBaseline * 0.9; 

            for (let i = 0; i < CHART_5MIN_POINTS; i++) {
                const time = new Date(now.getTime() + (i - LIVE_START_INDEX) * intervalMs);
                const label = time.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                
                initialHistory.labels.push(label);

                if (i < LIVE_START_INDEX) {
                    const fluctuation = (Math.random() - 0.5) * 0.25; 
                    simulatedPower = simulatedPower + fluctuation;
                    simulatedPower = Math.max(powerBaseline - 1.5, Math.min(powerBaseline + 1.5, simulatedPower)); 
                    
                    initialHistory.powerData.push(simulatedPower); 
                } else {
                    initialHistory.powerData.push(null); 
                }
            }
            
            selectedData.liveHistory = initialHistory;
            live5MinCounter = LIVE_START_INDEX; 
        }

        // --- 8 å°æ™‚æ­·å²æ•¸æ“šåˆå§‹åŒ– (æå‰åœ¨è¼‰å…¥æ™‚é‹è¡Œä»¥å„ªåŒ–åˆ‡æ›é€Ÿåº¦) ---
        function init8HourHistory(selectedData) {
            const basePower = selectedData.latest.realTimePower; 
            const basePF = selectedData.latest.powerFactor;
            const initialData = { labels: [], powerData: [], pfData: [], cumulativeEnergyData: [] }; 
            const now = new Date();
            const dataIntervalMs = 5 * 60 * 1000; // 5 åˆ†é˜é–“éš”
            const intervalHours = dataIntervalMs / (1000 * 60 * 60);

            let currentCumulativeEnergy = selectedData.latest.dailyEnergy - (basePower * 8 * 1.1);
            
            for(let i = 0; i < CHART_8H_POINTS; i++) {
                 const time = new Date(now.getTime() - (CHART_8H_POINTS - 1 - i) * dataIntervalMs);
                 initialData.labels.push(time.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', hour12: false }));
                 
                 const hour = time.getHours();
                 const dailyCycleFactor = 1 + Math.sin((hour / 24) * 2 * Math.PI) * 0.4;
                 const power = basePower * dailyCycleFactor + (Math.random() - 0.5) * 1.5;

                 initialData.powerData.push(power); 
                 initialData.pfData.push(basePF + (Math.random() - 0.5) * 0.05);
                 
                 const incrementalEnergy = power * intervalHours;
                 currentCumulativeEnergy += incrementalEnergy;
                 initialData.cumulativeEnergyData.push(currentCumulativeEnergy);
            }
            selectedData.eightHourHistory = initialData;
        }

        // 5åˆ†é˜å³æ™‚æ»¾å‹• (é«˜é »ç‡kW)
        function startLive5MinUpdates(selectedData) {
            stopAllChartIntervals();
            
            if (!selectedData.liveHistory) {
                init5MinHistory(selectedData);
            }
            
            if (selectedData.liveHistory.powerData.every(p => p !== null)) {
                live5MinCounter = CHART_5MIN_POINTS;
            }

            live5MinInterval = setInterval(() => {
                const newPower = selectedData.latest.realTimePower;
                const newLabel = getCurrentTimeLabel(); 

                if (live5MinCounter < CHART_5MIN_POINTS) {
                    selectedData.liveHistory.powerData[live5MinCounter] = newPower;
                    selectedData.liveHistory.labels[live5MinCounter] = newLabel;
                    live5MinCounter++;

                } else {
                    selectedData.liveHistory.labels.shift();
                    selectedData.liveHistory.powerData.shift();
                    
                    selectedData.liveHistory.labels.push(newLabel);
                    selectedData.liveHistory.powerData.push(newPower);
                }
                
                if (currentChart && currentInterval === '5min_live') {
                    currentChart.data.labels = selectedData.liveHistory.labels;
                    currentChart.data.datasets[0].data = selectedData.liveHistory.powerData;
                    
                    const basePower = selectedData.latest.realTimePower;
                    currentChart.options.scales.y1.suggestedMin = basePower - 1.5;
                    currentChart.options.scales.y1.suggestedMax = basePower + 1.5;
                    
                    currentChart.update('none'); 
                }
            }, 5000); 
        }

        // 8å°æ™‚å³æ™‚æ»¾å‹• (ä¸­é »ç‡kW/PF/kWh)
        function startLive8HourUpdates(selectedData) {
            stopAllChartIntervals();
            
            // ç”±æ–¼å·²åœ¨ initApp ä¸­é å…ˆåˆå§‹åŒ–ï¼Œé€™è£¡åªéœ€æª¢æŸ¥æ•¸æ“šæ˜¯å¦å­˜åœ¨
            if (!selectedData.eightHourHistory) {
                // å¦‚æœé åŠ è¼‰å¤±æ•—æˆ–æœªç™¼ç”Ÿï¼Œå‰‡é‡æ–°åŸ·è¡Œåˆå§‹åŒ–
                init8HourHistory(selectedData);
            }

            live8HourInterval = setInterval(() => {
                const updateSeconds = 10;
                const updateHours = updateSeconds / 3600;

                const newPower = selectedData.latest.realTimePower; 
                const newPF = selectedData.latest.powerFactor;
                const newLabel = getCurrentTimeLabel(false); 

                selectedData.eightHourHistory.labels.shift();
                selectedData.eightHourHistory.powerData.shift();
                selectedData.eightHourHistory.pfData.shift();
                selectedData.eightHourHistory.cumulativeEnergyData.shift(); 

                const latestCumulativeEnergy = selectedData.eightHourHistory.cumulativeEnergyData[selectedData.eightHourHistory.cumulativeEnergyData.length - 1];
                const newCumulativeEnergy = latestCumulativeEnergy + newPower * updateHours;
                
                selectedData.eightHourHistory.labels.push(newLabel);
                selectedData.eightHourHistory.powerData.push(newPower); 
                selectedData.eightHourHistory.pfData.push(newPF);
                selectedData.eightHourHistory.cumulativeEnergyData.push(newCumulativeEnergy);

                if (currentChart && currentInterval === '8h_live') {
                    currentChart.data.labels = selectedData.eightHourHistory.labels;
                    currentChart.data.datasets[0].data = selectedData.eightHourHistory.powerData;
                    currentChart.data.datasets[1].data = selectedData.eightHourHistory.pfData;
                    currentChart.data.datasets[2].data = selectedData.eightHourHistory.cumulativeEnergyData;

                    // æ›´æ–° Y3 è»¸ç¯„åœ
                    const minE = Math.min(...selectedData.eightHourHistory.cumulativeEnergyData);
                    const maxE = Math.max(...selectedData.eightHourHistory.cumulativeEnergyData);
                    currentChart.options.scales.y3.suggestedMin = minE * 0.995;
                    currentChart.options.scales.y3.suggestedMax = maxE * 1.005;

                    currentChart.update('none'); 
                }
            }, 10000); // 10 ç§’æ›´æ–°ä¸€æ¬¡ 
        }

        // å‡½æ•¸ï¼šæ›´æ–°åœ–è¡¨è¦–è¦ºè¨­å®š (ç”¨æ–¼æ·±è‰²æ¨¡å¼)
        function updateChartAppearance(isDark) {
            const fontColor = isDark ? '#f3f4f6' : '#1f2937';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            if (currentChart) {
                currentChart.options.color = fontColor;
                currentChart.options.plugins.title.color = fontColor;
                currentChart.options.plugins.legend.labels.color = fontColor;
                
                const scales = currentChart.options.scales;
                
                for (const scaleId in scales) {
                    if (scales[scaleId].display !== false) {
                        scales[scaleId].ticks.color = fontColor;
                        scales[scaleId].grid.color = gridColor;
                        scales[scaleId].title.color = fontColor; // ç¢ºä¿è»¸æ¨™é¡Œé¡è‰²ä¹Ÿæ›´æ–°
                    }
                }
                
                // è»¸ç·šé¡è‰²ä½¿ç”¨è®Šæ•¸ï¼Œä½†ç‰¹å®šè»¸çš„æ¨™é¡Œé¡è‰²ä¿æŒä¸è®Š
                scales.y1.title.color = 'rgb(59, 130, 246)'; // è—è‰²
                scales.y2.title.color = 'rgb(107, 114, 128)'; // ç°è‰²
                scales.y3.title.color = 'rgb(239, 68, 68)'; // ç´…è‰²

                currentChart.update();
            }
        }


        // å‡½æ•¸ï¼šç¹ªè£½æˆ–é‡æ–°ç¹ªè£½ Chart.js åœ–è¡¨
        function renderChart(data, interval, isCustom = false) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            const isDark = document.body.classList.contains('dark-mode');
            
            if (currentChart) currentChart.destroy();
            
            let datasets = [];
            let chartLabels = [];
            let chartTitle = '';
            let chartData = null;

            chartData = isCustom ? data.history : 
                        interval === '5min_live' ? data.liveHistory : 
                        data.eightHourHistory;

            if (!chartData || chartData.labels.length === 0) {
                if(interval === '5min_live') { init5MinHistory(data); chartData = data.liveHistory; }
                else if (interval === '8h_live') { init8HourHistory(data); chartData = data.eightHourHistory; }
                else { chartData = { labels: [], powerData: [], pfData: [], cumulativeEnergyData: [] }; }
            }
            
            chartLabels = chartData.labels;

            if (interval === '5min_live') {
                datasets.push({
                    label: 'å³æ™‚ç”¨é›» (kW)',
                    data: chartData.powerData,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    yAxisID: 'y1',
                    pointRadius: 3, 
                    pointHoverRadius: 5,
                    tension: 0.1,
                    spanGaps: true, 
                });
                chartTitle = `${data.name} - å³æ™‚ç”¨é›»è¶¨å‹¢ (5åˆ†é˜)`;

            } else { 
                
                datasets.push({ 
                    label: 'å³æ™‚ç”¨é›» (kW)', 
                    data: chartData.powerData, 
                    borderColor: 'rgb(59, 130, 246)', 
                    backgroundColor: 'rgba(59, 130, 246, 0.2)', 
                    yAxisID: 'y1', 
                    tension: 0.4,
                    pointRadius: 2, 
                });
                
                datasets.push({ 
                    label: 'åŠŸç‡å› ç´  (PF)', 
                    data: chartData.pfData, 
                    borderColor: 'rgb(107, 114, 128)', 
                    backgroundColor: 'rgba(107, 114, 128, 0.1)', 
                    yAxisID: 'y2', 
                    tension: 0.4,
                    pointRadius: 2,
                });

                datasets.push({ 
                    label: 'ç´¯ç©é›»é‡ (kWh)', 
                    data: chartData.cumulativeEnergyData, 
                    borderColor: 'rgb(239, 68, 68)', 
                    backgroundColor: 'rgba(239, 68, 68, 0.05)', 
                    yAxisID: 'y3', 
                    tension: 0.4,
                    pointRadius: 0, 
                    borderWidth: 2,
                    fill: false,
                });
                
                chartTitle = isCustom ? `${data.name} - è‡ªè¨‚å€é–“é›»åŠ›è¶¨å‹¢` : `${data.name} - 8 å°æ™‚å³æ™‚é›»åŠ›æ»¾å‹•`;
            }

            // --- ç¢ºå®š Y1 è»¸ (kW) çš„å»ºè­°ç¯„åœ (å·²ä¿®å¾© TypeError) ---
            let y1SuggestedMin = undefined;
            let y1SuggestedMax = undefined;

            if (interval === '5min_live' && data.latest) {
                const basePower = data.latest.realTimePower;
                y1SuggestedMin = basePower - 2;
                y1SuggestedMax = basePower + 2;
            } else if (chartData && chartData.powerData.length > 0) {
                const validPowerData = chartData.powerData.filter(v => v !== null);
                if (validPowerData.length > 0) {
                    const minP = Math.min(...validPowerData);
                    const maxP = Math.max(...validPowerData);
                    y1SuggestedMin = minP * 0.95;
                    y1SuggestedMax = maxP * 1.05;
                }
            }


            // ç¢ºå®š Y3 è»¸çš„å»ºè­°ç¯„åœ
            const isEnergyChart = interval !== '5min_live' && chartData.cumulativeEnergyData && chartData.cumulativeEnergyData.length > 0;
            const minEnergy = isEnergyChart ? Math.min(...chartData.cumulativeEnergyData) : 0;
            const maxEnergy = isEnergyChart ? Math.max(...chartData.cumulativeEnergyData) : 500;
            
            const fontColor = isDark ? '#f3f4f6' : '#1f2937';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

            currentChart = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: datasets },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false, },
                    plugins: { 
                        title: { display: true, text: chartTitle, font: { size: 16 }, color: fontColor },
                        legend: { labels: { color: fontColor } }
                    },
                    scales: { 
                        x: {
                            ticks: { maxTicksLimit: interval === '5min_live' ? 10 : 15, autoSkipPadding: 20, color: fontColor },
                            grid: { color: gridColor },
                        },
                        y1: { 
                            type: 'linear', display: true, position: 'left', 
                            title: { display: true, text: 'é›»åŠ› (kW)', color: 'rgb(59, 130, 246)' }, 
                            suggestedMin: y1SuggestedMin,
                            suggestedMax: y1SuggestedMax,
                            ticks: { color: fontColor },
                            grid: { color: gridColor },
                        },
                        y2: { 
                            type: 'linear', 
                            display: interval !== '5min_live', 
                            position: 'right', 
                            grid: { drawOnChartArea: false, color: gridColor }, 
                            min: 0.7, max: 1.0, 
                            title: { display: interval !== '5min_live', text: 'åŠŸç‡å› ç´  (PF)', color: 'rgb(107, 114, 128)' }, 
                            ticks: { color: fontColor },
                        },
                        y3: { 
                            type: 'linear', 
                            display: isEnergyChart, 
                            position: 'right', 
                            grid: { drawOnChartArea: false, color: gridColor }, 
                            title: { display: isEnergyChart, text: 'ç´¯ç©é›»é‡ (kWh)', color: 'rgb(239, 68, 68)' }, 
                            suggestedMin: minEnergy * 0.995,
                            suggestedMax: maxEnergy * 1.005,
                            ticks: { color: fontColor },
                        },
                    },
                },
            });
            document.getElementById('chart-section').style.display = 'block';
        }

        // --- æ·±è‰²æ¨¡å¼é‚è¼¯ ---

        window.toggleDarkMode = function() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDarkMode);
            
            // æ›´æ–°æŒ‰éˆ•åœ–æ¨™
            document.getElementById('dark-mode-icon').textContent = isDarkMode ? 'â˜€ï¸' : 'ğŸŒ™';

            // æ›´æ–°åœ–è¡¨å¤–è§€
            if (currentChart) {
                updateChartAppearance(isDarkMode);
            }
        }

        function loadDarkModePreference() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                document.getElementById('dark-mode-icon').textContent = 'â˜€ï¸';
            } else {
                 document.getElementById('dark-mode-icon').textContent = 'ğŸŒ™';
            }
        }

        // --- äº‹ä»¶è™•ç†å‡½æ•¸ ---

        window.switchArea = function(id) {
            selectedAreaId = id;
            const selectedData = areaData.find(d => d.id === id);

            if (selectedData) {
                document.getElementById('dashboard-title').textContent = `${selectedData.name} - ç›£æ§å„€è¡¨æ¿`;
                
                renderMetrics(selectedData);
                startRealTimeUpdates();
                
                switchInterval('5min_live'); 
                
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`btn-${id}`).classList.add('active');
            }
        };

        window.switchInterval = function(interval) {
            currentInterval = interval;
            const selectedData = areaData.find(d => d.id === selectedAreaId);

            document.querySelectorAll('.interval-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${interval}`).classList.add('active');

            const customSelector = document.getElementById('custom-range-selector');
            customSelector.style.display = interval === 'custom' ? 'flex' : 'none';

            stopAllChartIntervals();

            if (interval === '5min_live') {
                selectedData.liveHistory = null; // æ¯æ¬¡åˆ‡æ›éƒ½é‡æ–°åˆå§‹åŒ– 5 åˆ†é˜æ•¸æ“šä»¥ç¢ºä¿å¾ä¸­é–“é–‹å§‹å¡«å……
                renderChart(selectedData, '5min_live');
                startLive5MinUpdates(selectedData);
            } else if (interval === '8h_live') {
                // ç›´æ¥ä½¿ç”¨é å…ˆåˆå§‹åŒ–çš„æ•¸æ“šï¼Œä¸æœƒæœ‰æ˜é¡¯å»¶é²
                renderChart(selectedData, '8h_live');
                startLive8HourUpdates(selectedData);
            } else {
                if (currentChart) currentChart.destroy();
            }
        }

        window.generateCustomChart = function() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            
            if (!startDateInput || !endDateInput) {
                showCustomMessage("è«‹é¸æ“‡æœ‰æ•ˆçš„é–‹å§‹å’ŒçµæŸæ—¥æœŸæ™‚é–“ï¼", "error");
                return;
            }

            const startDate = new Date(startDateInput);
            const endDate = new Date(endDateInput);
            
            if (startDate >= endDate) {
                showCustomMessage("é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ï¼", "error");
                return;
            }

            stopAllChartIntervals();

            // --- æ¨¡æ“¬è‡ªè¨‚å€é–“æ•¸æ“š ---
            const selectedData = areaData.find(d => d.id === selectedAreaId);
            const diffMs = endDate.getTime() - startDate.getTime();
            const diffHours = diffMs / (1000 * 60 * 60);
            const dataPoints = Math.min(100, Math.ceil(diffHours * 10)); 

            const customLabels = [];
            const customPowerData = []; 
            const customPfData = [];
            const customEnergyData = []; 
            const stepMs = diffMs / dataPoints;
            const stepHours = stepMs / (1000 * 60 * 60);
            
            let currentMs = startDate.getTime();
            const basePower = selectedData.latest.realTimePower; 

            let cumulativeEnergy = selectedData.latest.dailyEnergy - (basePower * diffHours * 0.9);
            
            for (let i = 0; i < dataPoints; i++) {
                const time = new Date(currentMs);
                
                customLabels.push(time.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', hour12: false }));
                
                const activityFactor = 1 + Math.sin(time.getHours() / 12 * Math.PI) * 0.5; 
                const power = (basePower * activityFactor) + (Math.random() * 2);
                customPowerData.push(power); 
                
                customPfData.push(selectedData.latest.powerFactor + (Math.random() - 0.5) * 0.03);

                const incrementalEnergy = power * stepHours;
                cumulativeEnergy += incrementalEnergy;
                customEnergyData.push(cumulativeEnergy);

                currentMs += stepMs;
            }

            const customData = {
                name: selectedData.name,
                history: { 
                    labels: customLabels, 
                    powerData: customPowerData, 
                    pfData: customPfData, 
                    cumulativeEnergyData: customEnergyData 
                } 
            };
            
            renderChart(customData, 'custom', true);
            showCustomMessage("è‡ªè¨‚å€é–“åœ–è¡¨å·²ç”Ÿæˆï¼", "success");
        }
        
        // è‡ªè¨‚è¨Šæ¯æ¡† 
        function showCustomMessage(message, type) {
            const container = document.querySelector('.main-content');
            let msgBox = document.getElementById('custom-message-box');
            
            if (!msgBox) {
                msgBox = document.createElement('div');
                msgBox.id = 'custom-message-box';
                msgBox.style.cssText = `
                    position: fixed; top: 20px; right: 20px; padding: 15px 30px; 
                    border-radius: 8px; font-weight: 600; box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
                    z-index: 1000; transition: opacity 0.3s, transform 0.3s; opacity: 0;
                    transform: translateX(100%);
                `;
                container.appendChild(msgBox);
            }

            if (type === 'error') {
                msgBox.style.backgroundColor = '#fca5a5';
                msgBox.style.color = '#7f1d1d';
            } else if (type === 'success') {
                msgBox.style.backgroundColor = '#a7f3d0';
                msgBox.style.color = '#065f46';
            } else {
                msgBox.style.backgroundColor = '#bfdbfe';
                msgBox.style.color = '#1e40af';
            }
            
            msgBox.textContent = message;
            
            setTimeout(() => {
                msgBox.style.opacity = '1';
                msgBox.style.transform = 'translateX(0)';
            }, 50);

            setTimeout(() => {
                msgBox.style.opacity = '0';
                msgBox.style.transform = 'translateX(100%)';
            }, 3000);
        }

        // å‡½æ•¸ï¼šåˆå§‹åŒ–å°èˆªæ¬„
        function initNavigation() {
            const navContainer = document.getElementById('area-navigation');
            navContainer.innerHTML = areaData.map(area => `
                <button 
                    id="btn-${area.id}"
                    class="nav-button" 
                    onclick="switchArea('${area.id}')">
                    ${area.name}
                </button>
            `).join('');
        }

        // æ‡‰ç”¨ç¨‹å¼ä¸»åˆå§‹åŒ–å‡½æ•¸
        function initApp() {
            // 1. è¼‰å…¥æ·±è‰²æ¨¡å¼åå¥½
            loadDarkModePreference();
            
            // 2. åˆå§‹åŒ–å°èˆª
            initNavigation();

            // 3. é å…ˆåˆå§‹åŒ–æ‰€æœ‰å€åŸŸçš„ 8 å°æ™‚æ•¸æ“š (å„ªåŒ–è¼‰å…¥é€Ÿåº¦)
            areaData.forEach(init8HourHistory);
            
            // 4. é è¨­åˆ‡æ›åˆ°ç¬¬ä¸€å€‹å€åŸŸ
            switchArea(areaData[0].id);
        }

        // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
        window.onload = initApp;
    </script>
</body>
</html>
