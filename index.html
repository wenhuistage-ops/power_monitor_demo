<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é›»åŠ›ç›£æ§å„€è¡¨æ¿</title>
    <!-- å¼•å…¥ Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- é¡è‰²è®Šæ•¸ --- */
        :root {
            --sidebar-width: 250px;
            --bg-primary: #f4f7f6;
            --bg-secondary: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --border-color: #d1d5db;
            --nav-bg-hover: #e5e7eb;
            --kwh-color: rgb(239, 68, 68); /* Red */
            --header-height: 60px; /* é ‚éƒ¨æ¨™é ­é«˜åº¦ */
        }

        .dark-mode {
            --bg-primary: #1f2937;
            --bg-secondary: #2d3748;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #4b5563;
            --nav-bg-hover: #4a5568;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            transition: background-color 0.3s;
        }

        /* --- é ‚éƒ¨æ¨™é ­ (Header) æ¨£å¼ --- */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 50; 
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .header-title {
            font-size: 24px;
            font-weight: 800;
            color: #3b82f6; 
        }

        /* --- å´é‚Šæ¬„ (Sidebar) æ¨£å¼ --- */

        .sidebar {
            /* æ¡Œé¢æ¨£å¼ */
            width: var(--sidebar-width);
            flex-shrink: 0;
            background-color: var(--bg-secondary);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .sidebar-inner {
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
            margin-bottom: 10px;
            display: none; 
        }

        /* å°èˆªæŒ‰éˆ•æ¨£å¼ */
        .nav-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: none;
            background-color: transparent;
            color: var(--text-secondary);
            text-align: left;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, box-shadow 0.2s;
            font-weight: 500;
            white-space: nowrap;
        }

        .nav-button:hover {
            background-color: var(--nav-bg-hover);
        }

        .nav-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3);
        }

        .button-text {
            margin-left: 10px;
        }

        /* --- ä¸»è¦å…§å®¹å€æ¨£å¼ (Main Content) --- */

        .main-container {
            display: flex; 
            flex-grow: 1;
        }
        
        .main-content {
            flex-grow: 1;
            padding: 30px;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 30px;
        }

        .metric-card {
            background-color: var(--bg-secondary);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, background-color 0.3s, box-shadow 0.3s;
        }
        
        /* --- [æ–°å¢/ä¿®æ”¹] æŒ‡æ¨™å¡ç‰‡æ–‡å­—å¤§å° --- */
        .metric-card .metric-label {
            font-size: 16px; /* æ¨™ç±¤æ–‡å­— (ä¾‹å¦‚: å³æ™‚ç”¨é›») */
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .metric-card .metric-value {
            font-size: 36px; /* ä¸»è¦æ•¸å€¼æ–‡å­— (å·²æ”¾å¤§) */
            font-weight: 800;
            line-height: 1.2;
            margin: 0;
        }

        .metric-card .metric-unit {
            font-size: 18px; /* å–®ä½æ–‡å­— (ä¾‹å¦‚: kW) */
            font-weight: 600;
            color: var(--text-secondary);
            margin-top: 5px;
        }
        /* --- [çµæŸ] æŒ‡æ¨™å¡ç‰‡æ–‡å­—å¤§å° --- */


        .dark-mode .metric-card {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .chart-section {
            background-color: var(--bg-secondary);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .chart-canvas-container {
            height: 400px;
            width: 100%;
        }

        .interval-selector {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap; 
        }

        .interval-button {
            padding: 8px 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, color 0.2s;
            font-weight: 500;
        }

        .interval-button.active {
            background-color: #3b82f6;
            color: #ffffff;
            border-color: #3b82f6;
        }
        
        .kwh-toggle-button {
            background-color: var(--kwh-color);
            color: #ffffff;
            border-color: var(--kwh-color);
        }

        .kwh-toggle-button.inactive {
            background-color: transparent;
            color: var(--kwh-color);
            border: 1px dashed var(--kwh-color);
        }
        
        .mode-toggle-container {
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        /* --- éŸ¿æ‡‰å¼èª¿æ•´ (æ‰‹æ©Ÿæ¨¡å¼ < 768px) --- */
        @media (max-width: 767px) {
            
            .main-container {
                flex-direction: column; /* è®“å…§å®¹å‚ç›´å †ç–Š */
            }

            /* å´é‚Šæ¬„åœ¨æ‰‹æ©Ÿä¸Šè®Šæˆä¸‹æ‹‰é¸å–® */
            .sidebar {
                position: absolute; 
                top: var(--header-height);
                left: 0;
                width: 100%;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
                z-index: 40; 
                
                max-height: 0;
                opacity: 0;
                overflow: hidden;
                padding-top: 0;
                padding-bottom: 0;

                transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, padding 0.3s ease-in-out;
            }
            
            /* å±•é–‹ç‹€æ…‹ */
            .sidebar.expanded {
                max-height: 100vh;
                opacity: 1;
                padding-top: 20px;
                padding-bottom: 20px;
            }

            .main-content {
                padding: 15px; 
            }
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }

            .sidebar-inner {
                display: block; 
                margin-bottom: 20px;
            }
        }
        
        /* åƒ…åœ¨æ¡Œé¢æ¨¡å¼ (> 767px) éš±è—æ¼¢å ¡åŒ…æŒ‰éˆ• */
        @media (min-width: 768px) {
            #mobile-toggle-btn {
                display: none;
            }
        }
    </style>
</head>
<body>

    <!-- 1. é ‚éƒ¨æ¨™é ­ (åœ¨æ‰‹æ©Ÿä¸ŠåŒ…å«æ”¶ç¸®æŒ‰éˆ•) -->
    <header class="app-header">
        <div class="header-title flex-grow">é›»åŠ›ç›£æ§å„€è¡¨æ¿</div>
        
        <!-- æ‰‹æ©Ÿé¸å–®åˆ‡æ›æŒ‰éˆ• -->
        <button id="mobile-toggle-btn" class="p-2 rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition" onclick="toggleMobileSidebar()">
            <!-- æ¼¢å ¡åŒ…åœ–æ¨™ -->
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
        </button>
    </header>

    <!-- 2. ä¸»æ‡‰ç”¨ç¨‹å¼å®¹å™¨ (åŒ…å«å´é‚Šæ¬„å’Œå…§å®¹) -->
    <div class="main-container">
        <!-- å´é‚Šæ¬„ (Sidebar) -->
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-inner">
                 <h2 class="text-xl font-bold text-indigo-400">å€åŸŸé¸æ“‡</h2>
            </div>
            
            <div id="area-navigation">
                <!-- å°èˆªæŒ‰éˆ•å°‡ç”± JS æ¸²æŸ“ -->
            </div>
            
            <!-- æ·±è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
            <div class="mode-toggle-container">
                <button id="dark-mode-toggle" class="nav-button flex justify-center items-center" onclick="toggleDarkMode()">
                    ğŸŒ™<span class="button-text">æ·±è‰²æ¨¡å¼</span>
                </button>
            </div>
        </nav>

        <!-- ä¸»è¦å…§å®¹ -->
        <div class="main-content">
            <h2 id="dashboard-title" style="font-size: 32px; font-weight: 800; color: var(--text-primary); margin-bottom: 20px;">è«‹é¸æ“‡ä¸€å€‹ç›£æ§å€åŸŸ</h2>
            
            <div id="dashboard-metrics" class="metrics-grid">
                <!-- æŒ‡æ¨™å¡ç‰‡å°‡ç”± JS æ¸²æŸ“ -->
            </div>

            <div id="chart-section" class="chart-section" style="display: none;">
                <div class="interval-selector">
                    <button id="btn-5min_live" class="interval-button active" onclick="switchInterval('5min_live')">å³æ™‚è¶¨å‹¢ (5åˆ†)</button>
                    <button id="btn-3h_live" class="interval-button" onclick="switchInterval('3h_live')">3 å°æ™‚æ»¾å‹•</button>
                    <button id="btn-custom" class="interval-button" onclick="switchInterval('custom')">è‡ªè¨‚å€é–“</button>
                    <!-- ç´¯ç©é›»é‡åˆ‡æ›æŒ‰éˆ• -->
                    <button id="btn-toggle-kwh" class="interval-button kwh-toggle-button" onclick="toggleKwhLine()">éš±è—ç´¯ç©é›»é‡</button>
                </div>
                
                <!-- è‡ªè¨‚å€é–“é¸æ“‡ UI -->
                <div id="custom-range-selector" style="display: none; gap: 10px; flex-wrap: wrap; align-items: center;">
                    <label for="startDate">é–‹å§‹æ—¥æœŸ/æ™‚é–“:</label>
                    <input type="datetime-local" id="startDate" value="2025-10-17T00:00" class="p-2 border rounded">
                    <label for="endDate">çµæŸæ—¥æœŸ/æ™‚é–“:</label>
                    <input type="datetime-local" id="endDate" value="2025-10-17T08:00" class="p-2 border rounded">
                    <button class="interval-button" style="background-color: #10b981; border-color: #10b981; color: white;" onclick="generateCustomChart()">ç”Ÿæˆåœ–è¡¨</button>
                </div>

                <div class="chart-canvas-container">
                    <canvas id="historyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨åŸŸè®Šæ•¸èˆ‡å¸¸é‡ ---
        const CHART_5MIN_POINTS = 60;   
        const LIVE_START_INDEX = 30;    
        const CHART_3H_POINTS = 36;     
        const AREA_COUNT = 5;           
        
        let currentChart = null;        
        let selectedAreaId = 'A'; 
        let currentInterval = '5min_live';
        let realTimeInterval = null;    
        let live5MinInterval = null;    
        let live3HourInterval = null;   
        let live5MinCounter = LIVE_START_INDEX; 
        let isDarkMode = false;
        let showKwhLine = true;         
        
        const areaData = [];
        
        // --- åˆå§‹åŒ–é‚è¼¯ï¼š3å°æ™‚æ­·å²æ•¸æ“šé ç”Ÿæˆ ---

        function initAreaHistory(areaId, basePower, basePF) {
            const now = new Date();
            const initialData = { labels: [], powerData: [], pfData: [], kwhData: [] }; 
            const intervalMs = 5 * 60 * 1000; 
            let cumulativeEnergy = 0;
            const points = CHART_3H_POINTS; 

            for(let i = 0; i < points; i++) {
                 const time = new Date(now.getTime() - (points - 1 - i) * intervalMs);
                 
                 initialData.labels.push(time.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', hour12: false }));
                 
                 const areaFactor = areaId.charCodeAt(0) - 'A'.charCodeAt(0) + 1;
                 const dailyCycleFactor = 1 + Math.sin((time.getHours() / 24) * 2 * Math.PI) * (0.1 * areaFactor);

                 let simulatedPower = (basePower * dailyCycleFactor) + (Math.random() - 0.5) * 1.5;
                 let simulatedPF = basePF + (Math.random() - 0.5) * 0.05;
                 
                 simulatedPF = Math.min(1.0, Math.max(0.7, simulatedPF));
                 
                 initialData.powerData.push(simulatedPower); 
                 initialData.pfData.push(simulatedPF);
                 
                 cumulativeEnergy += simulatedPower * (5 / 60);
                 initialData.kwhData.push(cumulativeEnergy);
            }
            return initialData;
        }

        function initializeAppData() {
            const initialAreaNames = ['å€åŸŸ A - æ©Ÿæˆ¿æ ¸å¿ƒ', 'å€åŸŸ B - è¾¦å…¬å®¤æ¨“å±¤', 'å€åŸŸ C - ç ”ç™¼å¯¦é©—å®¤', 'å€åŸŸ D - ä¼‘æ¯èˆ‡é¤é£²å€', 'å€åŸŸ E - æˆ¶å¤–ç…§æ˜'];
            const initialBasePowers = [12.55, 4.12, 8.90, 1.50, 0.80];
            const initialBasePFs = [0.98, 0.85, 0.99, 0.92, 0.95];
            
            for(let i = 0; i < AREA_COUNT; i++) {
                const id = String.fromCharCode('A'.charCodeAt(0) + i);
                const basePower = initialBasePowers[i];
                const basePF = initialBasePFs[i];
                const threeHourHistory = initAreaHistory(id, basePower, basePF);

                areaData.push({ 
                    id: id, 
                    name: initialAreaNames[i], 
                    latest: { 
                        realTimePower: basePower, 
                        current: 0, 
                        voltage: 220.0, 
                        powerFactor: basePF, 
                        dailyEnergy: threeHourHistory.kwhData[threeHourHistory.kwhData.length - 1], 
                    }, 
                    liveHistory: null, 
                    eightHourHistory: threeHourHistory 
                });
                
                const latest = areaData[i].latest;
                const nominalCurrentFactor = 2.85; 
                latest.current = latest.realTimePower * nominalCurrentFactor / latest.powerFactor / 220.0 * latest.voltage;
                latest.current = parseFloat(latest.current.toFixed(2));
            }
        }

        // --- æ ¸å¿ƒé‚è¼¯ï¼šæŒ‡æ¨™æ›´æ–° (1 ç§’) ---
        
        function renderMetricCard(label, value, unit, colorClass) {
            return `<div class="metric-card"><p class="metric-label">${label}</p><p class="metric-value" style="color: ${colorClass};">${value.toFixed(2)}</p><p class="metric-unit">${unit}</p></div>`;
        }

        function renderMetrics(data) {
            const container = document.getElementById('dashboard-metrics');
            const latest = data.latest;
            const pfColor = latest.powerFactor < 0.9 ? '#ef4444' : '#10b981';

            container.innerHTML = `
                ${renderMetricCard("å³æ™‚ç”¨é›»", latest.realTimePower, "kW", "#3b82f6")}
                ${renderMetricCard("ç•¶æ—¥ç´¯ç©", latest.dailyEnergy, "kWh", "#f59e0b")}
                ${renderMetricCard("åŠŸç‡å› ç´ ", latest.powerFactor, "PF", pfColor)}
                ${renderMetricCard("é›»æµ", latest.current, "A", "#8b5cf6")}
                ${renderMetricCard("é›»å£“", latest.voltage, "V", "#4b5563")}
            `;
        }

        function startRealTimeUpdates() {
            if (realTimeInterval) clearInterval(realTimeInterval);

            realTimeInterval = setInterval(() => {
                const selectedData = areaData.find(d => d.id === selectedAreaId);
                
                if (selectedData) {
                    let latest = selectedData.latest;
                    let currentPower = latest.realTimePower;

                    const powerFluctuation = (Math.random() - 0.5) * 0.3; 
                    let newPower = Math.min(Math.max(currentPower + powerFluctuation, 0.1), 15); 
                    
                    latest.dailyEnergy += newPower * (1 / 3600); 

                    const voltageFluctuation = (Math.random() - 0.5) * 0.1;
                    latest.voltage = 220.0 + voltageFluctuation;

                    const pfFluctuation = (Math.random() - 0.5) * 0.005; 
                    let newPF = latest.powerFactor + pfFluctuation;
                    latest.powerFactor = Math.min(1.0, Math.max(0.7, newPF)); 

                    const nominalCurrentFactor = 2.85; 
                    latest.current = newPower * nominalCurrentFactor / latest.powerFactor / 220.0 * latest.voltage;
                    
                    latest.realTimePower = parseFloat(newPower.toFixed(2));
                    latest.dailyEnergy = parseFloat(latest.dailyEnergy.toFixed(3));
                    latest.current = parseFloat(latest.current.toFixed(2));
                    latest.voltage = parseFloat(latest.voltage.toFixed(2));

                    renderMetrics(selectedData);
                }
            }, 1000); 
        }

        // --- åœ–è¡¨ç›¸é—œå‡½æ•¸ ---

        function getCurrentTimeLabel(includeSeconds = true) {
            const options = { hour: '2-digit', minute: '2-digit', hour12: false };
            if (includeSeconds) {
                options.second = '2-digit';
            }
            return new Date().toLocaleTimeString('zh-Hant', options);
        }

        function stopAllChartIntervals() {
            if (live5MinInterval) clearInterval(live5MinInterval);
            if (live3HourInterval) clearInterval(live3HourInterval);
            live5MinInterval = null;
            live3HourInterval = null;
        }
        
        function getChartColors() {
            const isDark = document.body.classList.contains('dark-mode');
            return {
                gridColor: isDark ? 'rgba(255, 255, 255, 0.15)' : 'rgba(0, 0, 0, 0.1)',
                labelColor: isDark ? '#f9fafb' : '#1f2937',
                legendColor: isDark ? '#f9fafb' : '#1f2937'
            };
        }
        
        function init5MinHistory(selectedData) {
            const initialHistory = { labels: [], powerData: [] };
            const now = new Date();
            const intervalMs = 5000; 
            const basePower = selectedData.latest.realTimePower;

            for (let i = 0; i < CHART_5MIN_POINTS; i++) {
                const time = new Date(now.getTime() + (i - LIVE_START_INDEX) * intervalMs);
                const label = time.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
                
                initialHistory.labels.push(label);

                if (i < LIVE_START_INDEX) {
                    const noise = (Math.sin(i * 0.5) * 0.5) + (Math.random() - 0.5) * 0.5;
                    initialHistory.powerData.push(basePower + noise); 
                } else {
                    initialHistory.powerData.push(null); 
                }
            }
            
            selectedData.liveHistory = initialHistory;
            live5MinCounter = LIVE_START_INDEX;
        }

        function startLive5MinUpdates(selectedData) {
            stopAllChartIntervals();
            
            if (!selectedData.liveHistory) {
                init5MinHistory(selectedData);
            }
            
            if (!selectedData.liveHistory.powerData.includes(null)) {
                live5MinCounter = CHART_5MIN_POINTS;
            } else if (live5MinCounter === 0) {
                 live5MinCounter = LIVE_START_INDEX;
            }


            live5MinInterval = setInterval(() => {
                const newPower = selectedData.latest.realTimePower;
                const newLabel = getCurrentTimeLabel(); 

                if (live5MinCounter < CHART_5MIN_POINTS) {
                    selectedData.liveHistory.powerData[live5MinCounter] = newPower;
                    selectedData.liveHistory.labels[live5MinCounter] = newLabel;
                    live5MinCounter++;

                } else {
                    selectedData.liveHistory.labels.shift();
                    selectedData.liveHistory.powerData.shift();
                    
                    selectedData.liveHistory.labels.push(newLabel);
                    selectedData.liveHistory.powerData.push(newPower);
                }
                
                if (currentChart && currentInterval === '5min_live') {
                    currentChart.data.labels = selectedData.liveHistory.labels;
                    currentChart.data.datasets[0].data = selectedData.liveHistory.powerData;
                    
                    const basePower = selectedData.latest.realTimePower;
                    currentChart.options.scales.y1.suggestedMin = Math.max(0, basePower - 1.5);
                    currentChart.options.scales.y1.suggestedMax = basePower + 1.5;
                    
                    currentChart.update('none'); 
                }
            }, 5000); 
        }

        function startLive3HourUpdates(selectedData) {
            stopAllChartIntervals();
            const threeHourHistory = selectedData.eightHourHistory; 

            live3HourInterval = setInterval(() => {
                const latest = selectedData.latest;
                const newPower = latest.realTimePower; 
                const newPF = latest.powerFactor;
                const newEnergy = latest.dailyEnergy; 
                const newLabel = getCurrentTimeLabel(false); 

                threeHourHistory.labels.shift();
                threeHourHistory.powerData.shift();
                threeHourHistory.pfData.shift();
                threeHourHistory.kwhData.shift();
                
                threeHourHistory.labels.push(newLabel);
                threeHourHistory.powerData.push(newPower); 
                threeHourHistory.pfData.push(newPF);
                threeHourHistory.kwhData.push(newEnergy);

                if (currentChart && currentInterval === '3h_live') {
                    currentChart.data.labels = threeHourHistory.labels;
                    currentChart.data.datasets[0].data = threeHourHistory.powerData;
                    currentChart.data.datasets[1].data = threeHourHistory.pfData;
                    
                    if (showKwhLine) {
                         currentChart.data.datasets[2].data = threeHourHistory.kwhData;
                    }
                   
                    currentChart.update('none'); 
                }
            }, 10000); 
        }

        function generateCustomData(data, startDate, endDate) {
            const diffMs = endDate.getTime() - startDate.getTime();
            const diffHours = diffMs / (1000 * 60 * 60);
            const dataPoints = Math.min(200, Math.ceil(diffHours * 10)); 

            const customLabels = [];
            const customPowerData = []; 
            const customPfData = [];
            const customKwhData = []; 
            const stepMs = diffMs / dataPoints;
            
            let currentMs = startDate.getTime();
            const basePower = data.latest.realTimePower;
            const basePF = data.latest.powerFactor;
            let cumulativeEnergy = 0;

            for (let i = 0; i < dataPoints; i++) {
                const time = new Date(currentMs);
                customLabels.push(time.toLocaleDateString('zh-Hant', { month: '2-digit', day: '2-digit' }) + ' ' + time.toLocaleTimeString('zh-Hant', { hour: '2-digit', minute: '2-digit', hour12: false }));
                
                const activityFactor = 1 + Math.sin(time.getHours() / 12 * Math.PI) * 0.5; 
                let simulatedPower = (basePower * activityFactor) + (Math.random() * 2);
                customPowerData.push(simulatedPower); 
                
                let simulatedPF = basePF + (Math.random() - 0.5) * 0.03;
                customPfData.push(Math.min(1.0, Math.max(0.7, simulatedPF))); 

                cumulativeEnergy += simulatedPower * (stepMs / (1000 * 60 * 60));
                customKwhData.push(cumulativeEnergy);

                currentMs += stepMs;
            }

            return { labels: customLabels, powerData: customPowerData, pfData: customPfData, kwhData: customKwhData };
        }

        function renderChart(data, interval, isCustom = false) {
            const ctx = document.getElementById('historyChart').getContext('2d');
            
            if (currentChart) currentChart.destroy();
            
            const colors = getChartColors();
            
            let datasets = [];
            let chartLabels = [];
            let chartTitle = '';
            let chartData = isCustom ? data.history : 
                            interval === '5min_live' ? data.liveHistory : 
                            data.eightHourHistory;

            if (!chartData || chartData.labels.length === 0) {
                if(interval === '5min_live') init5MinHistory(data);
                chartData = data.liveHistory; 
            }


            if (interval === '5min_live') {
                chartLabels = chartData.labels;
                datasets.push({
                    label: 'å³æ™‚ç”¨é›» (kW)',
                    data: chartData.powerData,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    yAxisID: 'y1',
                    pointRadius: 3, 
                    pointHoverRadius: 5,
                    tension: 0.1,
                    spanGaps: true,
                });
                chartTitle = `${data.name} - å³æ™‚ç”¨é›»è¶¨å‹¢ (5åˆ†é˜)`;

            } else { 
                chartLabels = chartData.labels;
                
                datasets.push({ 
                    label: 'å³æ™‚ç”¨é›» (kW)', 
                    data: chartData.powerData, 
                    borderColor: 'rgb(59, 130, 246)', 
                    backgroundColor: 'rgba(59, 130, 246, 0.2)', 
                    yAxisID: 'y1', 
                    tension: 0.4,
                    pointRadius: 2, 
                    fill: 'origin',
                });
                
                datasets.push({ 
                    label: 'åŠŸç‡å› ç´  (PF)', 
                    data: chartData.pfData, 
                    borderColor: 'rgb(16, 185, 129)', 
                    backgroundColor: 'rgba(16, 185, 129, 0.1)', 
                    yAxisID: 'y2', 
                    tension: 0.4,
                    pointRadius: 2,
                });

                if (showKwhLine) {
                    datasets.push({ 
                        label: 'ç´¯ç©é›»é‡ (kWh)', 
                        data: chartData.kwhData, 
                        borderColor: 'rgb(239, 68, 68)', 
                        backgroundColor: 'rgba(239, 68, 68, 0.1)', 
                        yAxisID: 'y3', 
                        tension: 0.4,
                        pointRadius: 2,
                        borderWidth: 3,
                    });
                }
                
                chartTitle = isCustom ? `${data.name} - è‡ªè¨‚å€é–“é›»åŠ›è¶¨å‹¢` : `${data.name} - 3 å°æ™‚å³æ™‚é›»åŠ›æ»¾å‹•`;
            }

            currentChart = new Chart(ctx, {
                type: 'line',
                data: { labels: chartLabels, datasets: datasets },
                options: {
                    responsive: true, 
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false, },
                    plugins: { 
                        title: { display: true, text: chartTitle, font: { size: 16 }, color: colors.labelColor },
                        legend: { position: 'top', labels: { color: colors.legendColor } }
                    },
                    scales: { 
                        x: {
                            ticks: { 
                                maxTicksLimit: interval === '5min_live' ? 10 : 15,
                                autoSkipPadding: 20,
                                color: colors.labelColor
                            },
                            grid: { color: colors.gridColor }
                        },
                        y1: { 
                            type: 'linear', display: true, position: 'left', 
                            title: { display: true, text: 'é›»åŠ› (kW)', color: colors.labelColor }, 
                            ticks: { color: colors.labelColor },
                            grid: { color: colors.gridColor },
                            suggestedMin: (interval === '5min_live') ? Math.max(0, data.latest.realTimePower - 2) : undefined,
                            suggestedMax: (interval === '5min_live') ? data.latest.realTimePower + 2 : undefined,
                            min: 0,
                        },
                        y2: { 
                            type: 'linear', 
                            display: interval !== '5min_live',
                            position: 'right', 
                            min: 0.7, 
                            max: 1.0, 
                            title: { display: interval !== '5min_live', text: 'åŠŸç‡å› ç´  (PF)', color: colors.labelColor }, 
                            ticks: { color: colors.labelColor },
                            grid: { drawOnChartArea: false, color: colors.gridColor }, 
                        },
                         y3: { 
                            type: 'linear', 
                            display: showKwhLine && interval !== '5min_live',
                            position: 'right', 
                            min: 0,
                            title: { display: showKwhLine && interval !== '5min_live', text: 'ç´¯ç©é›»é‡ (kWh)', color: 'rgb(239, 68, 68)' }, 
                            ticks: { color: 'rgb(239, 68, 68)' },
                            grid: { drawOnChartArea: false, color: colors.gridColor }, 
                        },
                    },
                },
            });
            document.getElementById('chart-section').style.display = 'block';
        }

        // --- éŸ¿æ‡‰å¼ï¼šæ‰‹æ©Ÿæ¨¡å¼ä¸‹æ”¶ç¸®/å±•é–‹é¸å–® ---
        function isMobileView() {
            // èˆ‡ CSS ä¸­çš„ @media (max-width: 767px) åŒ¹é…
            return window.matchMedia("(max-width: 767px)").matches;
        }

        window.toggleMobileSidebar = function(forceClose = false) {
            const sidebar = document.getElementById('sidebar');
            
            if (!isMobileView()) return; 

            const isExpanded = sidebar.classList.contains('expanded');
            
            if (forceClose || isExpanded) {
                // æ”¶ç¸®
                sidebar.classList.remove('expanded');
            } else {
                // å±•é–‹
                sidebar.classList.add('expanded');
            }
        }
        
        // è™•ç†è¦–çª—å¤§å°è®ŠåŒ–ï¼Œç¢ºä¿é¸å–®ç‹€æ…‹æ­£ç¢º
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('sidebar');
            if (!isMobileView()) {
                // æ¡Œé¢æ¨¡å¼ï¼šç¢ºä¿é¸å–®æ˜¯å®Œå…¨å±•é–‹çš„ï¼ˆç§»é™¤æ‰‹æ©Ÿæ”¶ç¸®é¡åˆ¥ï¼‰
                sidebar.classList.remove('expanded'); 
            } else {
                 // æ‰‹æ©Ÿæ¨¡å¼ï¼šé è¨­æ”¶èµ·ä¾†
                 sidebar.classList.remove('expanded');
            }
        });


        // --- å…¶ä»–äº‹ä»¶è™•ç†å‡½æ•¸ ---
        
        window.toggleKwhLine = function() {
            if (currentInterval === '5min_live') return;

            showKwhLine = !showKwhLine;
            const toggleBtn = document.getElementById('btn-toggle-kwh');

            if (showKwhLine) {
                toggleBtn.textContent = 'éš±è—ç´¯ç©é›»é‡';
                toggleBtn.classList.remove('inactive');
            } else {
                toggleBtn.textContent = 'é¡¯ç¤ºç´¯ç©é›»é‡';
                toggleBtn.classList.add('inactive');
            }
            
            const selectedData = areaData.find(d => d.id === selectedAreaId);
            
            if (currentInterval === 'custom') {
                 const startDate = new Date(document.getElementById('startDate').value);
                 const endDate = new Date(document.getElementById('endDate').value);
                 const customHistory = generateCustomData(selectedData, startDate, endDate);
                 renderChart({...selectedData, history: customHistory}, 'custom', true);
            } else {
                renderChart(selectedData, currentInterval);
            }
        }

        window.switchArea = function(id) {
            selectedAreaId = id;
            const selectedData = areaData.find(d => d.id === id);

            if (selectedData) {
                const isDark = document.body.classList.contains('dark-mode');
                document.getElementById('dashboard-title').style.color = isDark ? 'var(--text-primary)' : '#1f2937';
                document.getElementById('dashboard-title').textContent = `${selectedData.name} - ç›£æ§å„€è¡¨æ¿`;
                
                renderMetrics(selectedData);
                startRealTimeUpdates();
                
                switchInterval('5min_live'); 
                
                document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`btn-${id}`).classList.add('active');

                // æ–°å¢ï¼šåœ¨æ‰‹æ©Ÿæ¨¡å¼ä¸‹ï¼Œé¸å®Œå€åŸŸå¾Œè‡ªå‹•æ”¶èµ·é¸å–®
                window.toggleMobileSidebar(true);
            }
        };

        window.switchInterval = function(interval) {
            currentInterval = interval;
            const selectedData = areaData.find(d => d.id === selectedAreaId);
            const kwhToggleBtn = document.getElementById('btn-toggle-kwh');

            document.querySelectorAll('.interval-button').forEach(btn => {
                 if (btn.id !== 'btn-toggle-kwh') {
                    btn.classList.remove('active');
                 }
            });
            if (document.getElementById(`btn-${interval}`)) {
                document.getElementById(`btn-${interval}`).classList.add('active');
            }

            if (interval === '5min_live') {
                kwhToggleBtn.style.display = 'none';
            } else {
                kwhToggleBtn.style.display = 'inline-block';
                if (showKwhLine) {
                    kwhToggleBtn.textContent = 'éš±è—ç´¯ç©é›»é‡';
                    kwhToggleBtn.classList.remove('inactive');
                } else {
                    kwhToggleBtn.textContent = 'é¡¯ç¤ºç´¯ç©é›»é‡';
                    kwhToggleBtn.classList.add('inactive');
                }
            }

            const customSelector = document.getElementById('custom-range-selector');
            customSelector.style.display = interval === 'custom' ? 'flex' : 'none';

            stopAllChartIntervals();

            if (interval === '5min_live') {
                selectedData.liveHistory = null; 
                renderChart(selectedData, '5min_live');
                startLive5MinUpdates(selectedData);
            } else if (interval === '3h_live') { 
                renderChart(selectedData, '3h_live');
                startLive3HourUpdates(selectedData); 
            } else {
                if (currentChart) currentChart.destroy();
            }
        }

        window.generateCustomChart = function() {
            const startDateInput = document.getElementById('startDate').value;
            const endDateInput = document.getElementById('endDate').value;
            
            if (!startDateInput || !endDateInput) {
                console.error("è«‹é¸æ“‡æœ‰æ•ˆçš„é–‹å§‹å’ŒçµæŸæ—¥æœŸæ™‚é–“ï¼");
                return;
            }

            const startDate = new Date(startDateInput);
            const endDate = new Date(endDateInput);
            
            if (startDate >= endDate) {
                console.error("é–‹å§‹æ™‚é–“å¿…é ˆæ—©æ–¼çµæŸæ™‚é–“ï¼");
                return;
            }

            stopAllChartIntervals();

            const selectedData = areaData.find(d => d.id === selectedAreaId);
            const customHistory = generateCustomData(selectedData, startDate, endDate);
            
            const customDataWrapper = {
                ...selectedData,
                history: customHistory
            };
            
            renderChart(customDataWrapper, 'custom', true);
        }
        
        window.toggleDarkMode = function() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            
            const modeBtn = document.getElementById('dark-mode-toggle');
            modeBtn.innerHTML = isDarkMode ? 'â˜€ï¸<span class="button-text">æ·ºè‰²æ¨¡å¼</span>' : 'ğŸŒ™<span class="button-text">æ·±è‰²æ¨¡å¼</span>';
            
            if (currentChart) {
                const selectedData = areaData.find(d => d.id === selectedAreaId);
                
                if (currentInterval === 'custom') {
                    const startDate = new Date(document.getElementById('startDate').value);
                    const endDate = new Date(document.getElementById('endDate').value);
                    const customHistory = generateCustomData(selectedData, startDate, endDate);
                    renderChart({...selectedData, history: customHistory}, 'custom', true);
                } else {
                    renderChart(selectedData, currentInterval);
                }
            }
            const titleElement = document.getElementById('dashboard-title');
            titleElement.style.color = isDarkMode ? 'var(--text-primary)' : '#1f2937';
        }
        

        // --- å•Ÿå‹•å‡½æ•¸ ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppData();
            
            // æ¸²æŸ“å°èˆªæŒ‰éˆ•
            const navContainer = document.getElementById('area-navigation');
            areaData.forEach(area => {
                const button = document.createElement('button');
                button.className = 'nav-button';
                button.id = `btn-${area.id}`;
                button.innerHTML = `<span class="button-id">${area.id}</span><span class="button-text">${area.name}</span>`;
                button.onclick = () => window.switchArea(area.id);
                navContainer.appendChild(button);
            });

            // é è¨­é¸æ“‡ç¬¬ä¸€å€‹å€åŸŸ
            window.switchArea('A');
        });

    </script>
</body>
</html>
